<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../at-core-theme/at-core-theme.html">
<link rel="import" href="../at-doc-parser/at-doc-parser.html">
<link rel="import" href="../marked-element/marked-element.html">

<dom-module id="at-doc-viewer">
  <style>
    .doc-container {
      margin: 0 10%;
    }

    .header > label {
      font-weight: 500;
      font-size: 21px;
    }

    .header > p {
      margin-left: 8px;
      font-size: 13px;
    }

    .doc-container > .section {
      margin-top: 13px;
      margin-left: 21px;
      border: 1px solid gray;
      border-bottom: none;
    }

    .section > .title {
      margin-left: 5px;
      font-weight: 500;
      font-size: 17px;
    }

    .items-container > .item-container:first-child {
      border-top: 1px solid gray;
      border-bottom: 1px solid gray;
    }

    .items-container > .item-container {
      border-bottom: 1px solid gray;
    }

    .signature .name {
      font-weight: bold;
      margin-left: 13px;
    }

    .item-container > .property.signature {
      float: left;
      width: 144px;
    }

    .item-container.hidden {
      display: none;
    }

    .item-container > .property.details {
      margin-left: 144px;
      padding: 0;
    }

    .item-container > .details {
      padding-left: 144px;
    }

    .details p {
      /*remove semantic.css effect*/
      margin: 0;
    }

    .details > .params-return-wrapper {
      background: rgba(0, 0, 0, 0.05)
    }
  </style>
  <template>
    <at-doc-parser id="docParser" url="{{url}}"></at-doc-parser>
    <div class="vertical layout doc-container">
      <div class="header">
        <label>{{data.name}}</label>
        <marked-element text="{{data.description}}">
          <div class="markdown-html"></div>
        </marked-element>
      </div>
      <template is="dom-if" if="{{data.properties.length}}">
        <div class="vertical layout section">
          <label class="title">Properties</label>
          <div class="vertical layout items-container">
            <template is="dom-repeat" items="{{data.properties}}">
              <div class="item-container" hidden$="[[item.private]]">
                <div class="horizontal layout property signature">
                  <span class="name">{{item.name}}</span>
                </div>
                <div class="vertical layout property details">
                  <div class="params-return-wrapper">
                    <p>Type:
                      <span class="param-type">{{item.type}}</span>
                    </p>
                    <p>Default:
                      <span>{{item.default}}</span>
                    </p>
                  </div>
                  <marked-element class="item-description" text="{{item.description}}">
                    <div class="markdown-html"></div>
                  </marked-element>
                </div>
              </div>
            </template>
          </div>
        </div>
      </template>
      <template is="dom-if" if="{{data.methods.length}}">
        <div class="vertical layout section">
          <label class="title">Methods</label>
          <div class="vertical layout items-container">
            <template is="dom-repeat" items="{{data.methods}}">
              <div class="item-container" hidden$="[[item.private]]">
                <div class="horizontal layout signature">
                  <p>
                    <span class="name">{{item.name}}</span>
                    <span>(</span>
                    <template is="dom-if" if="{{item.params}}">
                      <span class="param-list">[[_computeParamList(item.params)]]</span>
                    </template>
                    <span>)</span>
                    <template is="dom-if" if="{{item.return}}">
                      <span>âž™ {</span>
                      <span class="return-type">{{item.return.type}}</span>
                      <span>}</span>
                    </template>
                  </p>
                </div>
                <div class="vertical layout details">
                  <div class="params-return-wrapper">
                    <template is="dom-repeat" items="{{item.params}}" as="param">
                      <p>
                        <span class="param-name">{{param.name}}</span>
                        <span>{</span>
                        <span class="param-type">{{param.type}}</span>
                        <span>}</span>
                        <marked-element class="param-description" text="{{param.description}}">
                          <div class="markdown-html"></div>
                        </marked-element>
                      </p>
                    </template>
                    <template is="dom-if" if="{{item.return}}">
                      <p>
                        <span>Returns {</span>
                        <span class="return-type">{{item.return.type}}</span>
                        <span>}</span>
                        <marked-element class="return-description">{{item.return.description}}</marked-element>
                      </p>
                    </template>
                  </div>
                  <marked-element class="item-description" text="{{item.description}}">
                    <div class="markdown-html"></div>
                  </marked-element>
                </div>
              </div>
            </template>
          </div>
        </div>
      </template>
      <template is="dom-if" if="{{data.events.length}}">
        <div class="vertical layout section">
          <label class="title">Events</label>
          <div class="vertical layout items-container">
            <template is="dom-repeat" items="{{data.events}}">
              <div class="vertical layout item-container">
                <div class="horizontal layout item">
                  <div class="flex-2 signature">
                    <label class="name">{{item.name}}</label>
                  </div>
                  <div class="flex-10 details">
                    <marked-element class="item-description" text="{{item.description}}">
                      <div class="markdown-html"></div>
                    </marked-element>
                  </div>
                </div>
              </div>
            </template>
          </div>
        </div>
      </template>
    </div>
  </template>
  <script>
    'use strict';
    Polymer({
      is: 'at-doc-viewer',
      properties: {
        url: {
          type: String,
          value: ''
        },
        auto: {
          type: Boolean,
          value: false
        }
      },
      _scopeCssViaAttr: true,
      ready: function() {
        var docParser = this.$.docParser;
        var self = this;
        docParser.addEventListener('value-changed', function(event) {
          if (docParser.value.length > 0) {
            var value = docParser.value[0];
            self.data = value;
          }
        });
        if (this.auto && this.url === '') {
          // autogenerate the url
          // debugger;
          var url = window.location.href;
          if (url.indexOf("index.html") !== -1) {
            var urlParts = url.split("/");
            if (urlParts.length > 2) {
              var componentName = urlParts[urlParts.length - 2];
              self.url = componentName + '.html';
            }
          }
        }
      },
      _computeParamList: function(params) {
        var
          result = [];
        params.forEach(function(param, index) {
          result.push(param.name);
        });
        result = result.join(", ");
        return result;
      }
    });
  </script>
</dom-module>
