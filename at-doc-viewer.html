<link rel="import" href="../tangere/tangere.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../at-core-theme/at-core-theme.html">
<link rel="import" href="../at-doc-parser/at-doc-parser.html">
<link rel="import" href="../at-core-markdown/at-core-markdown.html">
<link rel="import" href="../at-carbon-tabs/at-carbon-tab.html">
<link rel="import" href="../at-carbon-tabs/at-carbon-tabs.html">
<link rel="import" href="../at-doc-demo/at-doc-demo.html">
<link rel="import" href="../at-theme/at-theme.html">

<dom-module id="at-doc-viewer"> 
  <template>
    <style>     

      .doc-container {
        @apply(--paper-font-body1);
        margin: 0 auto;
        padding: 0 32px;
        max-width: 1400px;        
      }

      .header > label {
        font-weight: 500;
        font-size: 21px;
      }

      .header > p {
        margin-left: 8px;
        font-size: 13px;
      }

      .doc-container > .section {
        margin-top: 13px;
        margin-left: 21px;
        border: 1px solid gray;
        border-bottom: none;
      }

      .section > .title {
        @apply(--paper-font-headline);
        margin-bottom: 8px;
      }

      .items-container > .item-container:first-child {
        border-top: 1px solid gray;
        border-bottom: 1px solid gray;
      }

      .items-container > .item-container {
        border-bottom: 1px solid gray;
      }

      .signature .name {
        font-weight: bold;
        margin-left: 13px;
      }

      .item-container > .property.signature {
        float: left;
        width: 144px;
      }

      .item-container.hidden {
        display: none;
      }

      .item-container > .property.details {
        margin-left: 144px;
        padding: 0;
      }

      .item-container > .details {
        padding-left: 144px;
      }

      .details p {
        /*remove semantic.css effect*/
        margin: 0;
      }

      .details > .params-return-wrapper {
        background: rgba(0, 0, 0, 0.05);
      }


      .documentation {
        margin: 32px;
      }

      .documentation.hidden {
        display: none;
      }

      .playground.hidden {
        display: none;
      }

      .tab-selector.hidden {
        display: none;
      }

      .header {
        text-align: center;
      }

    </style>

    <at-doc-parser id="docParser" url="{{url}}"></at-doc-parser>
    <div class="vertical layout doc-container">
      <div class="header">
        <label>{{data.name}}</label>
        <at-core-markdown text="{{data.description}}">
          <div class="markdown-html"></div>
        </at-core-markdown>
      </div>
      <div>
        <div id="tabSelectorWrapper" class="tab-selector hidden">
          <at-carbon-tabs id="tabSelector" selected="documentation" attr-for-selected="data-name">
            <at-carbon-tab data-name="documentation">API Reference</at-carbon-tab>
            <at-carbon-tab data-name="playground">Playground</at-carbon-tab>
          </at-carbon-tabs>
        </div>
      </div>
      <div id="documentation" class="documentation">
        <template is="dom-if" if="{{data.properties.length}}">
          <div class="vertical layout section">
            <label class="title">Properties</label>
            <div class="vertical layout items-container">
              <template is="dom-repeat" items="{{data.properties}}">
                <div class="item-container" hidden$="[[item.private]]">
                  <div class="horizontal layout property signature">
                    <span class="name">{{item.name}}</span>
                  </div>
                  <div class="vertical layout property details">
                    <div class="params-return-wrapper">
                      <p>Type:
                        <span class="param-type">{{item.type}}</span>
                      </p>
                      <p>Default:
                        <span>{{item.default}}</span>
                      </p>
                      <template is="dom-if" if="{{item.possibleValues}}">
                        <p>
                          Possible values:
                          <span>{{item.possibleValues}}</span>
                        </p>
                      </template>
                    </div>
                    <at-core-markdown class="item-description" text="{{item.description}}">
                      <div class="markdown-html"></div>
                    </at-core-markdown>
                  </div>
                </div>
              </template>
            </div>
          </div>
        </template>
        <template is="dom-if" if="{{data.methods.length}}">
          <div class="vertical layout section">
            <label class="title">Methods</label>
            <div class="vertical layout items-container">
              <template is="dom-repeat" items="{{data.methods}}">
                <div class="item-container" hidden$="[[item.private]]">
                  <div class="horizontal layout signature">
                    <p>
                      <span class="name">{{item.name}}</span>
                      <span>(</span>
                      <template is="dom-if" if="{{item.params}}">
                        <span class="param-list">[[_computeParamList(item.params)]]</span>
                      </template>
                      <span>)</span>
                      <template is="dom-if" if="{{item.return}}">
                        <span>âž™ {</span>
                        <span class="return-type">{{item.return.type}}</span>
                        <span>}</span>
                      </template>
                    </p>
                  </div>
                  <div class="vertical layout details">
                    <div class="params-return-wrapper">
                      <template is="dom-repeat" items="{{item.params}}" as="param">
                        <p>
                          <span class="param-name">{{param.name}}</span>
                          <span>{</span>
                          <span class="param-type">{{param.type}}</span>
                          <span>}</span>
                          <at-core-markdown class="param-description" text="{{param.description}}">
                            <div class="markdown-html"></div>
                          </at-core-markdown>
                        </p>
                      </template>
                      <template is="dom-if" if="{{item.return}}">
                        <p>
                          <span>Returns {</span>
                          <span class="return-type">{{item.return.type}}</span>
                          <span>}</span>
                          <at-core-markdown class="return-description">{{item.return.description}}</at-core-markdown>
                        </p>
                      </template>
                    </div>
                    <at-core-markdown class="item-description" text="{{item.description}}">
                      <div class="markdown-html"></div>
                    </at-core-markdown>
                  </div>
                </div>
              </template>
            </div>
          </div>
        </template>
        <template is="dom-if" if="{{data.events.length}}">
          <div class="vertical layout section">
            <label class="title">Events</label>
            <div class="vertical layout items-container">
              <template is="dom-repeat" items="{{data.events}}">
                <div class="vertical layout item-container">
                  <div class="horizontal layout item">
                    <div class="flex-2 signature">
                      <label class="name">{{item.name}}</label>
                    </div>
                    <div class="flex-10 details">
                      <at-core-markdown class="item-description" text="{{item.description}}">
                        <div class="markdown-html"></div>
                      </at-core-markdown>
                    </div>
                  </div>
                  <template is="dom-if" if="{{item.params}}">
                    <div class="details">
                      <template is="dom-repeat" items="{{item.params}}" as="param">
                        <div class="params-return-wrapper">
                          <p>
                            <span class="param-name">{{param.name}}</span>
                            <span>{</span>
                            <span class="param-type">{{param.type}}</span>
                            <span>}</span>
                          </p>
                        </div>
                        <at-core-markdown class="param-description" text="{{param.description}}">
                          <div class="markdown-html"></div>
                        </at-core-markdown>
                      </template>
                    </div>
                  </template>
                </div>
              </template>
            </div>
          </div>
        </template>
      </div>
      <div id="playground" class="playground hidden">
        <at-doc-demo id="atDocDemo" url={{url}} hide="true"></at-doc-demo>
      </div>
    </div>
  </template>
  <script>
    'use strict';
    Polymer({
      is: 'at-doc-viewer',
      properties: {
        url: {
          type: String,
          value: ''
        },
        auto: {
          type: Boolean,
          value: false
        }
      },
      _scopeCssViaAttr: true,
      ready: function() {
        var docParser = this.$.docParser;
        var self = this;
        docParser.addEventListener('value-changed', function(event) {
          if (docParser.value.length > 0) {
            var value = docParser.value[0];
            self.data = value;
          }
        });
        if (this.auto && this.url === '') {
          // autogenerate the url
          // #761 at-doc-viewer?element=a-b
          // code below handles #761
          var params = window.location.search;
          if (params) {
            params = params.substr(1);
            var paramsParts = params.split('&');
            var i;
            var len = paramsParts.length;
            var paramPart;
            for (i = 0; i < len; i++) {
              paramPart = paramsParts[i];
              if (paramPart.startsWith('element=')) {
                break;
              }
            }
            if (paramPart.indexOf('=') !== -1) {
              var namePart = paramPart.split('=')[1];
              var result = '';
              if (namePart.indexOf('/') === -1) {
                result = namePart + '/' + namePart + '.html';
              } else {
                result = namePart + '.html';
              }
              self.url = '../' + result;
            }
            // end of #761 handle
            // debugger;
          } else {
            var url = window.location.href;
            if (url.indexOf("index.html") !== -1) {
              var urlParts = url.split("/");
              if (urlParts.length > 2) {
                var componentName = urlParts[urlParts.length - 2];
                self.url = componentName + '.html';
              }
            }
          }

          var elementName = componentName || namePart;
          self.importHref(self.url, function (event) {
            var element = document.createElement(elementName);
            if (element.$meta && element.$meta.length > 0) {
              var metaEntry = element.$meta[0];
              var playground = true;

              if (metaEntry.playground !== undefined) {
                playground = Boolean(metaEntry.playground);
              }
            } else {
              playground = true;
            }
            self.playgroundChanged(playground);
          });
        }
      },
      playgroundChanged: function(newValue, oldValue) {
        var self = this;
        var tabSelector = this.$.tabSelector;
        var documentationDiv = this.$.documentation;
        var playgroundDiv = this.$.playground;
        var tabSelectorWrapper = this.$.tabSelectorWrapper;
        self.toggleClass('hidden', !newValue, tabSelectorWrapper);

        tabSelector.addEventListener('tab-changed', function(event) {
          var value = event.detail.value;
          if (value.currentTab === 'documentation') {
            self.toggleClass('hidden', true, playgroundDiv);
            self.toggleClass('hidden', false, documentationDiv);
          } else {
            self.toggleClass('hidden', false, playgroundDiv);
            self.toggleClass('hidden', true, documentationDiv);
            self.debounce('resetResizeSensor', function(event) {
              self.$.atDocDemo.resetResizeSensor();
              self.$.atDocDemo.hide = false;
            }, 100);
          }
        });
      },
      _computeParamList: function(params) {
        var
          result = [];
        params.forEach(function(param, index) {
          result.push(param.name);
        });
        result = result.join(", ");
        return result;
      }
    });
  </script>
</dom-module>
